:docinfo:
include::./common_docinfo_vars.adoc[]

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// General comments
// Keep in mind that this is a "getting started" guide and the
//   audience that you are trying to reach.
// Leverage ASCIIDoc features to make this document readable and usable:
//   - Text highlights (follow SUSE style guides)
//   - Admonitions (i.e., NOTE, TIP, IMPORTANT, CAUTION, WARNING)
//   - Code blocks
//   - Lists (ordered and unordered, as appropriate)
//   - Links (to other resources)
//   - Images
//     - Place image files under the ./media directory tree
//       (e.g., ./media/src/svg, ./media/src/png)
//     - Format preference: svg > png > jpg
//     - Consolidate images wherever possible
//       (i.e., don't use two images when one conveys the message)
//   - Use sections and subsections to organize and group related
//     steps.
// 
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =


// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Document attributes and variables
//
// NOTES:
// 1. Update variables below and adjust docbook file accordingly.
// 2. Comment out any variables/attributes not used.
// 3. Follow the pattern to include additional variables.
//
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// organization - do NOT modify
// -
:trd: Technical Reference Documentation
:type: Getting Started
// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// document
// -
:title: Multi-tenancy with Clastix Kamaji
:subtitle: Enable Efficient Kubernetes Cluster Isolation

:product1: Rancher
:product1_full: Rancher Prime by SUSE
:product1_version: 2.7.3
:product1_url: https://www.suse.com/solutions/enterprise-container-management/#rancher-product
:product1_url_docs: https://ranchermanager.docs.rancher.com
:product1_url_github: https://github.com/rancher
:product1_url_supportmatrix: https://www.suse.com/suse-rancher/support-matrix/all-supported-versions/rancher-v2-7-4/
:product2: Kamaji
:product2_full: Clastix Kamaji
:product2_url: https://clastix.io/kamaji
:product2_url_github: https://github.com/clastix/kamaji
:product2_url_partner: https://clastix.io/
:product3: SLES
:product3_full: SUSE Linux Enterprise Server
:product3_url: https://www.suse.com/products/server/


:usecase: multi-tenancy for Kubernetes

:executive_summary: Enable efficient and secure Kubernetes resource sharing by implementing {usecase} with {product2_full} and {product1_full}.
// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// contributor
// specify information about authors, editors, and others here,
// then update docinfo file as appropriate
// -
:author1_firstname: Dario
:author1_surname: Tranchitella
:author1_jobtitle: Technical Advisor
:author1_orgname: Clastix
:author2_firstname: Dominic
:author2_surname: Geeverghese
:author2_jobtitle: Solutions Architect
:author2_orgname: SUSE
:author3_firstname: Terry
:author3_surname: Smith
:author3_jobtitle: Director, global partner solutions
:author3_orgname: SUSE
// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
// miscellaneous
// define any additional variables here for use within the document
// -
:rke2_url: https://docs.rke2.io/
:k3s_url: https://k3s.io/
// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -


= {title}: {subtitle}



== Introduction

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Provide a brief statement (1-4 sentences) of the purpose of the guide.
// This is could be the same as the executive summary.
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

Efficiency, security, and cost savings are top concerns for most businesses.
This becomes particularly important for large enterprises, who need to share Kubernetes infrastructure and resources between multiple teams, departments, or business units.
These are also concerns for managed services providers, who offer Kubernetes-as-a-Service or leverage Kubernetes to deliver other services.

Multi-tenancy enables different users or tenants to securely share Kubernetes resources, simplifying administration and reducing costs.
Multi-tenancy is recognized as key to achieving these goals.
Yet Kubernetes does not have first-class concepts of end users or tenants.

image::logo-lockup_suse+clastix_hor_lightbackground.svg["SUSE | Clastix", scaledwidth="75%", align="center"]


By integrating {product2_url}[Clastix Kamaji] into your {product1_url}[SUSE Rancher Prime] environment, you gain: 

* highly scalable and high density Kubernetes control plane infrastructure. 

* reduced operational overhead, yielding faster deployment, configuration, upgrades, and maintenance. 

* consistent configurations across multiple tenants. 

* distributed architectures across clouds, edge, and data center. 

* hard multi-tenancy with strong security and isolation.


=== Scope

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Specify what this guide covers in no more than 2 sentences.
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

Learn how to deploy {product2_url}[Clastix Kamaji] into an existing Kubernetes cluster managed by {product1_url}[{product1_full}].


=== Audience

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Identify for whom this document is intended, perhaps with:
//   - topics of interests (e.g., machine learning, security, etc.)
//   - job roles (e.g., developer, administrator, platform architect, etc.)
//   - required skills
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

Systems architects, platform engineers, administrators, and others seeking efficient operation of Kubernetes infrastructure through multi-tenancy and secure workload isolation will find this guide relevant.

A basic understanding of Kubernetes and cluster management with {product1} are needed.


=== Prerequisites

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Identify minimum requirements (prerequisites) the reader
// would need in order to follow the steps of this guide.
// - Link to existing resources whenever possible.
// - Keep this section brief but elaborate as needed.
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

To perform the steps detailed in this guide, you need the following:

* a {product1} by SUSE Kubernetes environment.
//
+
{product1} {product1_version} or later is recommended to support Rancher Extensions.
//
+
See {product1_url_docs}[{product1} Deployment Quick Start Guides] for more information on setting up your {product1} environment.

* a Kubernetes cluster to be used as the {product2} Admin Cluster, managed by {product1}.
+
--
Any CNCF-certified Kubernetes cluster can be used, including {rke2_url}[RKE2] and {k3s_url}[K3s].

This cluster should consist of a minimum of:

* 3 control plane nodes.

* 3 worker nodes.

* a {product1_url_docs}/faq/container-network-interface-providers[container network interface] (CNI) module, such as Calico or Cilium.

* a container storage interface (CSI) with a defined {product1_url_docs}/pages-for-subheaders/create-kubernetes-persistent-storage[StorageClass] for the tenant datastores.
+
[TIP]
====
The {product1} {product1_url_github}/local-path-provisioner[Local Path Provisioner] is an option if a storage backend is not available.
====

--

* a {product1_url_docs}/pages-for-subheaders/load-balancer-and-ingress-controller[load balancer], such as MetalLB or one provided by your cloud platform.
+
[IMPORTANT]
====
The addresses provided by the load balancer must be accessible by the worker nodes of the tenant clusters as well as by tenant users.
====

* https://cert-manager.io/[Cert-Manager].
//
+
Kamaji takes advantage of dynamic admission control, such as validating and mutating webhook configurations.
These webhooks are secured by the https://en.wikipedia.org/wiki/Transport_Layer_Security[TLS] cryptographic protocol, and the certificates are managed by cert-manager.

* an arbitrary number of Linux systems to function as worker nodes for tenant workloads.
+
--
Worker nodes are where your tenants' containerized workloads run.
They can be bare metal or virtual machines, on-premises or on any cloud provider.

// TERRY: Resume here



--





== Technical overview

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Provide a technical overview of the solution.
// - Identify components.
// - Describe how the components fit together.
//   Leverage diagrams as appropriate, including (but not limited to):
//   - component architecture
//   - data flow diagram
//   - workflow diagram
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =





== Installation

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Detail the steps of the installation procedure.
// The reader should be able to copy and paste commands to
// a local environment or follow along locally with screenshots.
// Include one or more verification steps to validate installation.
//
// Leverage:
// - Ordered lists
// - Code blocks
// - Screenshots
// - Admonitions
//
// If multiple installation methods are to be detailed, then
// - Create a summary list here
// - Detail each method in its own subsection.
//
// NOTE: For solutions involving SUSE Rancher, it is preferred
//       to detail two installation methods:
//       - Through the Rancher Apps Catalog with appropriate
//         screenshots and SUSE branding.
//       - A more manual approach (e.g., on the command-line).
//
// Complex configuration procedures may be broken out into one or more
// Configuration sections.
// These may be subsections of Installation or separate sections at
// the same level as Installation.
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

Installing the Kamaji Operator and Datastore

Make sure that you have administrive permissions on the cluster you want to turn into Kamaji Admin cluster and check that you can access it through the Rancher UI or the command line interface.

[NOTE]
====
As per current Rancher recommendations, do not install Kamaji on the local cluster where Rancher is running. Instead, use a dedicated downstream cluster.
====

Installing the Kamaji Operator and Datastore

Install with Helm

The preferred way to install the Kamaji operator is with the Helm chat.

[source, bash]
----
helm repo add clastix https://clastix.github.io/charts
helm repo update
helm install kamaji clastix/kamaji -n kamaji-system --create-namespace
----

The Kamaji operator needs to access a datastore to save data of the tenants' clusters. The Kamaji Helm chart provides the installation of a basic, unmanaged etcd as datastore.

[TIP]
====
It is highly recommended you install a managed datastore in production, such as https://cloudnative-pg.io/ [CloudNativePG], an open-source PostgreSQL distribution for Kubernetes. If you are hesitant about using PostgreSQL, the https://github.com/clastix/kamaji-etcd [kamaji-etcd] Helm chart sets up a multi-tenant etcd datastore running as a StatefulSet of three replicas.
====

Installing from Rancher

Alternatively, the Kamaji Operator and the default datastore can be installed from the Rancher Apps Catalog.

Navigate to Apps & Marketplace > Charts within the Rancher UI and search for “Kamaji”, then click on the Install


== Demonstration

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Illustrate functionality with a demonstration.
// Begin with a description or outline of the demonstration.
// Provide clear steps (in ordered lists) for the reader to follow.
// Typical demonstration flow is:
// 1. Prepare the environment for the demonstration.
//    This should be minimal, such as downloading some data to use.
//    If this requires more than a couple steps, consider putting it
//    in a subsection.
// 2. Perform the demonstration.
//    Be careful not to overuse screenshots.
// 3. Verify.
//    This may be interwoven into performing the demonstration.
//
// As with Installation, leverage ordered lists, code blocks,
// admonitions, and screenshots.
//
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =





== Summary

// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Summarize:
// - Motivation (1 sentence)
// - What was covered (1-2 sentences)
// - Next steps (unordered list of 2-4 further learning resources)
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

In this guide, you learned ...





// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
// Do not modify below this break.
// = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =

++++
<?pdfpagebreak?>
++++


:leveloffset: 0

== Legal notice
include::common_trd_legal_notice.adoc[]

++++
<?pdfpagebreak?>
++++


:leveloffset: 0
include::common_gfdl1.2_i.adoc[]

//end
